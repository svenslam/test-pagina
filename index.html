<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<title>iPhone Bewegingsalarm</title>
<style>
body { font-family: sans-serif; text-align:center; background:#111; color:#eee; }
.btn { padding:15px 30px; margin:10px; font-size:20px; cursor:pointer; border-radius: 8px; border: none; color: #fff; background-color: #007aff; transition: background-color 0.3s ease; }
.btn:hover { background-color: #0056b3; }
#keypad { display:none; margin-top:30px; }
.digit { width:80px; height:80px; font-size:28px; margin:5px; cursor:pointer; border-radius: 8px; border: 1px solid #333; background-color: #333; color: #eee; }
.digit:hover { background-color: #555; }
#pin { width: calc(80px * 3 + 5px * 4); height: 50px; font-size: 24px; text-align: center; margin-bottom: 10px; border-radius: 8px; border: 1px solid #555; background-color: #222; color: #eee; }
.status-indicator { margin-top: 20px; font-size: 18px; font-weight: bold; }
.status-indicator.active { color: #28a745; } /* Groen voor actief */
.status-indicator.inactive { color: #dc3545; } /* Rood voor inactief */
</style>
</head>
<body>
<h1>iPhone Bewegingsalarm</h1>

<div class="status-indicator" id="alarmStatus">Alarm Inactief</div>
<div class="status-indicator" id="sensorStatus">Sensoren: Niet Geactiveerd</div>

<div>
<button class="btn" onclick="enableMotion()">Start Sensoren</button>
<button class="btn" onclick="activateAlarm()">Alarm Aan</button>
<button class="btn" onclick="showKeypad()">Alarm Uit</button>
</div>

<div id="keypad"></div>

<audio id="siren" loop>
<source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" type="audio/ogg">
</audio>

<script>
let alarmActive = false;
let motionPermission = false;
let audioCtx, oscillator;
const siren = document.getElementById('siren');
let moving = false;
let moveTime = 0; // cumulatieve tijd in ms
let lastUpdate = null;
let sirenStarted = false;
const SENSITIVITY_THRESHOLD = 0.5; // Verlaagde drempelwaarde voor beweging (was 1)
const ALARM_TRIGGER_TIME_MS = 1000; // Alarm af laten gaan na 1 seconde continue beweging (was 2000)
const PIN_CODE = "1968"; // De pincode voor het uitschakelen van het alarm

const alarmStatusElement = document.getElementById('alarmStatus');
const sensorStatusElement = document.getElementById('sensorStatus');

let audioInitialized = false; // Vlag om te controleren of de audio is geïnitialiseerd

// Functie om de audio te initialiseren na een gebruikersinteractie
function initAudio() {
    if (audioInitialized) return;
    try {
        // Maak de AudioContext aan
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
        
        // Laad en "ontgrendel" het sirene-audiobestand door het kort af te spelen en te pauzeren
        siren.load();
        const playPromise = siren.play();
        if (playPromise !== undefined) {
            playPromise.then(() => {
                siren.pause();
                siren.currentTime = 0;
                console.log("Audio is succesvol ontgrendeld.");
            }).catch(error => {
                console.warn("Kon audio niet automatisch ontgrendelen.", error);
            });
        }
        audioInitialized = true;
    } catch (e) {
        console.error("Kon AudioContext niet aanmaken:", e);
        alert("Web Audio API wordt niet ondersteund in deze browser.");
    }
}

// Functie om de status-indicatoren bij te werken
function updateStatusIndicators() {
    if (alarmActive) {
        alarmStatusElement.textContent = "Alarm: ACTIEF";
        alarmStatusElement.className = "status-indicator active";
    } else {
        alarmStatusElement.textContent = "Alarm: Inactief";
        alarmStatusElement.className = "status-indicator inactive";
    }

    if (motionPermission) {
        sensorStatusElement.textContent = "Sensoren: Geactiveerd";
        sensorStatusElement.className = "status-indicator active";
    } else {
        sensorStatusElement.textContent = "Sensoren: Niet Geactiveerd";
        sensorStatusElement.className = "status-indicator inactive";
    }
}

// Initialiseer status bij laden van de pagina
document.addEventListener('DOMContentLoaded', updateStatusIndicators);


async function enableMotion(){
    initAudio(); // Initialiseer audio bij de eerste gebruikersactie
    // Voorkom dubbele registratie van de event listener
    if (motionPermission) {
        alert("Bewegingssensoren zijn al geactiveerd.");
        return;
    }

    if (typeof DeviceMotionEvent.requestPermission === 'function') {
        try {
            const permissionResult = await DeviceMotionEvent.requestPermission();
            if(permissionResult === 'granted'){
                motionPermission = true;
                alert("Bewegingssensor geactiveerd. U kunt nu het alarm inschakelen.");
                // Voeg de event listener hier toe, na toestemming
                window.addEventListener('devicemotion', handleMotion);
            } else {
                alert("Toegang tot bewegingssensor geweigerd.");
            }
        } catch(e) {
            alert("Fout bij aanvragen bewegingssensor toestemming: " + e.message);
        }
    } else {
        // Voor browsers die requestPermission niet ondersteunen (meestal Android/Chrome)
        motionPermission = true;
        alert("Bewegingssensor geactiveerd. U kunt nu het alarm inschakelen.");
        window.addEventListener('devicemotion', handleMotion);
    }
    updateStatusIndicators();
}

function activateAlarm(){
    initAudio(); // Zorg ervoor dat de audio is geïnitialiseerd
    if(!motionPermission) {
        alert("Eerst sensoren activeren!");
        return;
    }
    if (alarmActive) {
        alert("Alarm is al ingeschakeld.");
        return;
    }

    alarmActive = true;
    alert("Alarm ingeschakeld. Het alarm gaat af bij beweging.");
    moveTime = 0;
    sirenStarted = false;
    lastUpdate = null;
    updateStatusIndicators();
}

function handleMotion(e){
    if(!alarmActive || sirenStarted) return; // Stop verwerking als alarm inactief is of sirene al speelt

    let ax = Math.abs(e.acceleration.x||0);
    let ay = Math.abs(e.acceleration.y||0);
    let az = Math.abs(e.acceleration.z||0);
    let totalAcceleration = ax + ay + az;
    let now = Date.now();

    if(totalAcceleration > SENSITIVITY_THRESHOLD){ // Beweging gedetecteerd
        if(lastUpdate) {
            moveTime += (now - lastUpdate);
        }
        lastUpdate = now;

        if(!moving){
            moving = true;
            startTone();
        }
        if(oscillator) oscillator.frequency.value = 200 + Math.min(moveTime, ALARM_TRIGGER_TIME_MS * 2) / 10;

        if(moveTime >= ALARM_TRIGGER_TIME_MS){
            if (!sirenStarted) {
                stopTone();
                startSiren();
                sirenStarted = true;
            }
        }
    } else {
        if (moving) {
            moving = false;
            moveTime = 0;
            stopTone();
        }
        lastUpdate = now;
    }
}

function startTone(){
    if(!audioCtx || oscillator) return;
    if (audioCtx.state === 'suspended') audioCtx.resume(); // Zorg ervoor dat de context actief is
    oscillator = audioCtx.createOscillator();
    oscillator.type = "sine";
    oscillator.frequency.value = 200;
    oscillator.connect(audioCtx.destination);
    oscillator.start();
}

function stopTone(){
    if(oscillator){
        oscillator.stop();
        oscillator.disconnect();
        oscillator = null;
    }
    // Sluit de audiocontext niet, zodat deze hergebruikt kan worden
}

function startSiren(){
    if (siren.paused) {
        const playPromise = siren.play();
        if (playPromise !== undefined) {
            playPromise.catch(e => {
                // Log de fout naar de console i.p.v. een alert te tonen
                console.error("Fout bij afspelen sirene: ", e.message);
            });
        }
    }
}
function stopSiren(){
    siren.pause();
    siren.currentTime=0;
}

function showKeypad(){
    let kp = document.getElementById('keypad');
    kp.style.display = 'block';
    kp.innerHTML='';

    let input = document.createElement('input');
    input.type='password';
    input.id='pin';
    input.readOnly=true;
    input.placeholder = "Voer PIN in";
    kp.appendChild(input);
    kp.appendChild(document.createElement('br'));

    for(let i=1;i<=9;i++){
        addBtn(i,kp);
        if(i%3==0) kp.appendChild(document.createElement('br'));
    }
    kp.appendChild(document.createElement('br'));
    addBtn(0,kp);

    let ok = document.createElement('button');
    ok.className="digit";
    ok.textContent="OK";
    ok.onclick=()=>{
        if(input.value===PIN_CODE){
            deactivateAlarm();
            input.value = '';
        } else {
            alert("Onjuiste pincode!");
            input.value='';
        }
    };
    kp.appendChild(ok);

    let clearBtn = document.createElement('button');
    clearBtn.className="digit";
    clearBtn.textContent="CLR";
    clearBtn.onclick=()=>{
        input.value='';
    };
    kp.appendChild(clearBtn);
}

function addBtn(n,kp){
    let b=document.createElement('button');
    b.className='digit';
    b.textContent=n;
    b.onclick=()=>{
        const pinInput = document.getElementById('pin');
        if (pinInput.value.length < PIN_CODE.length) {
            pinInput.value+=n;
        }
    };
    kp.appendChild(b);
}

function deactivateAlarm(){
    alarmActive=false;
    stopTone();
    stopSiren();
    document.getElementById('keypad').style.display='none';
    alert("Alarm gedeactiveerd.");
    updateStatusIndicators();
}
</script>
</body>
</html>

